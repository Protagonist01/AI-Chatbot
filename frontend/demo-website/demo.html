<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Urban Threads - Demo</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.263.1"
      }
    }
    </script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    /* Custom scrollbar for chat */
    .overflow-y-scroll::-webkit-scrollbar {
      width: 6px;
    }

    .overflow-y-scroll::-webkit-scrollbar-track {
      background: transparent;
    }

    .overflow-y-scroll::-webkit-scrollbar-thumb {
      background-color: rgba(0, 0, 0, 0.1);
      border-radius: 3px;
    }
  </style>
</head>

<body>
  <div id="root"></div>

  <script type="text/babel" data-type="module">
    import React, { useState, useEffect, useRef } from 'react';
    import { createRoot } from 'react-dom/client';
    import { MessageCircle, X, Send, ShoppingCart, Heart, Search, Menu, Star, Truck, Shield, ArrowRight, ChevronDown, Filter, User } from 'lucide-react';

    // Generate a random session ID
    const generateSessionId = () => {
      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
        var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
      });
    };

    const SESSION_ID = generateSessionId();
    const API_BASE_URL = 'http://localhost:8000';
    const WS_BASE_URL = 'ws://localhost:8000';

    function ShopifyDemo() {
      const [chatOpen, setChatOpen] = useState(false);
      const [messages, setMessages] = useState([
        { type: 'bot', text: "üëã Welcome to Urban Threads! I'm your shopping assistant. I can help you find products, check stock, track orders, apply discounts, and answer any questions. What are you looking for today?" }
      ]);
      const [input, setInput] = useState('');
      const [isTyping, setIsTyping] = useState(false);
      const [cartCount, setCartCount] = useState(2);
      const messagesEndRef = useRef(null);
      const ws = useRef(null);

      const scrollToBottom = () => {
        messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
      };

      useEffect(() => {
        scrollToBottom();
      }, [messages]);

      // Initialize WebSocket connection
      useEffect(() => {
        ws.current = new WebSocket(`${WS_BASE_URL}/ws/chat/${SESSION_ID}`);

        ws.current.onopen = () => {
          console.log('Connected to chat server');
        };

        ws.current.onmessage = (event) => {
          const data = JSON.parse(event.data);

          if (data.type === 'bot_message') {
            setIsTyping(false);
            setMessages(prev => [...prev, { type: 'bot', text: data.payload.message }]);
          } else if (data.type === 'takeover_success') {
            setMessages(prev => [...prev, { type: 'system', text: "üë©‚Äçüíº A human agent has joined the chat." }]);
          }
        };

        ws.current.onclose = () => {
          console.log('Disconnected from chat server');
        };

        // Keep connection alive
        const pingInterval = setInterval(() => {
          if (ws.current?.readyState === WebSocket.OPEN) {
            ws.current.send(JSON.stringify({ type: 'ping' }));
          }
        }, 30000);

        return () => {
          clearInterval(pingInterval);
          ws.current?.close();
        };
      }, []);

      const quickReplies = [
        "1", "2", "3", "4", "5", "6", "7", "8"
      ];

      const categories = [
        { id: 1, name: 'Product Questions', icon: 'üõçÔ∏è' },
        { id: 2, name: 'Orders & Tracking', icon: 'üì¶' },
        { id: 3, name: 'Returns & Exchanges', icon: '‚Ü©Ô∏è' },
        { id: 4, name: 'Payments & Billing', icon: 'üí≥' },
        { id: 5, name: 'Sizing & Fit', icon: 'üìè' },
        { id: 6, name: 'Account & Security', icon: 'üë§' },
        { id: 7, name: 'Promotions & Discounts', icon: 'üéâ' },
        { id: 8, name: 'Talk to a Human Agent', icon: 'üë®‚Äçüíº' }
      ];

      const handleSend = async () => {
        if (input.trim() === '') return;

        const userMessage = { type: 'user', text: input };
        setMessages(prev => [...prev, userMessage]);
        setInput('');
        setIsTyping(true);

        try {
          const response = await fetch(`${API_BASE_URL}/webhook/web-message`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              user_id: SESSION_ID,
              message: userMessage.text,
              user_name: "Demo User",
              metadata: {
                source: "demo_website"
              }
            }),
          });

          if (!response.ok) {
            throw new Error('Failed to send message');
          }
        } catch (error) {
          console.error('Error sending message:', error);
          setIsTyping(false);
          setMessages(prev => [...prev, { type: 'error', text: "‚ö†Ô∏è Failed to send message. Please try again." }]);
        }
      };

      const handleQuickReply = (reply) => {
        setInput(reply);
      };

      const products = [
        { id: 1, name: "Classic White Tee", price: 29.99, oldPrice: 39.99, rating: 4.8, reviews: 342, image: "üëï", badge: "Sale", color: "bg-gradient-to-br from-gray-100 to-gray-200" },
        { id: 2, name: "Slim Fit Jeans", price: 79.99, rating: 4.9, reviews: 456, image: "üëñ", badge: "Bestseller", color: "bg-gradient-to-br from-blue-100 to-blue-200" },
        { id: 3, name: "Leather Jacket", price: 149.99, oldPrice: 199.99, rating: 4.7, reviews: 189, image: "üß•", badge: "40% Off", color: "bg-gradient-to-br from-amber-100 to-amber-200" },
        { id: 4, name: "Running Shoes", price: 89.99, rating: 4.9, reviews: 567, image: "üëü", badge: "New", color: "bg-gradient-to-br from-green-100 to-green-200" },
        { id: 5, name: "Cotton Hoodie", price: 54.99, rating: 4.6, reviews: 234, image: "üëî", color: "bg-gradient-to-br from-purple-100 to-purple-200" },
        { id: 6, name: "Sport Watch", price: 129.99, oldPrice: 159.99, rating: 4.8, reviews: 445, image: "‚åö", badge: "Sale", color: "bg-gradient-to-br from-red-100 to-red-200" },
      ];

      return (
        <div className="min-h-screen bg-gray-50">
          {/* Top Banner */}
          <div className="bg-black text-white text-center py-2 text-sm">
            üéâ FLASH SALE: Extra 20% OFF Everything | Use Code: <span className="font-bold">SAVE20</span> | Free Shipping Over $50
          </div>

          {/* Header */}
          <header className="bg-white shadow-sm sticky top-0 z-40">
            <div className="max-w-7xl mx-auto px-4">
              {/* Top Header */}
              <div className="flex items-center justify-between py-4">
                <div className="flex items-center space-x-2">
                  <div className="bg-gradient-to-r from-purple-600 to-pink-600 text-white p-2 rounded-lg">
                    <ShoppingCart className="w-6 h-6" />
                  </div>
                  <span className="text-2xl font-bold bg-gradient-to-r from-purple-600 to-pink-600 bg-clip-text text-transparent">
                    Urban Threads
                  </span>
                </div>

                {/* Search Bar */}
                <div className="hidden md:flex flex-1 max-w-xl mx-8">
                  <div className="relative w-full">
                    <input type="text" placeholder="Search for products, brands, and more..."
                      className="w-full border border-gray-300 rounded-lg pl-4 pr-10 py-2 focus:outline-none focus:ring-2 focus:ring-purple-600" />
                    <Search className="absolute right-3 top-2.5 w-5 h-5 text-gray-400" />
                  </div>
                </div>

                {/* Actions */}
                <div className="flex items-center space-x-6">
                  <User className="w-6 h-6 text-gray-600 cursor-pointer hover:text-purple-600" />
                  <Heart className="w-6 h-6 text-gray-600 cursor-pointer hover:text-pink-600" />
                  <div className="relative cursor-pointer">
                    <ShoppingCart className="w-6 h-6 text-gray-600 hover:text-purple-600" />
                    <span className="absolute -top-2 -right-2 bg-pink-600 text-white text-xs w-5 h-5 rounded-full flex items-center justify-center font-bold">
                      {cartCount}
                    </span>
                  </div>
                </div>
              </div>

              {/* Navigation */}
              <nav className="border-t py-3">
                <div className="flex items-center justify-between">
                  <div className="flex space-x-8">
                    <a href="#" className="text-gray-700 hover:text-purple-600 font-medium">New Arrivals</a>
                    <a href="#" className="text-gray-700 hover:text-purple-600 font-medium">Men</a>
                    <a href="#" className="text-gray-700 hover:text-purple-600 font-medium">Women</a>
                    <a href="#" className="text-gray-700 hover:text-purple-600 font-medium">Accessories</a>
                    <a href="#" className="text-red-600 hover:text-red-700 font-bold">Sale üî•</a>
                  </div>
                  <div className="flex items-center space-x-2 text-sm text-gray-600">
                    <Truck className="w-4 h-4" />
                    <span>Free Shipping Over $50</span>
                  </div>
                </div>
              </nav>
            </div>
          </header>

          {/* Hero Section */}
          <section className="bg-gradient-to-r from-purple-600 via-pink-600 to-red-600 text-white py-16">
            <div className="max-w-7xl mx-auto px-4">
              <div className="grid md:grid-cols-2 gap-8 items-center">
                <div>
                  <h1 className="text-5xl font-bold mb-4">Winter Collection 2024</h1>
                  <p className="text-xl mb-6 text-purple-100">Up to 40% OFF on all winter essentials</p>
                  <div className="flex space-x-4">
                    <button className="bg-white text-purple-600 px-8 py-3 rounded-lg font-semibold hover:bg-gray-100 flex items-center">
                      Shop Now
                      <ArrowRight className="ml-2 w-5 h-5" />
                    </button>
                    <button className="border-2 border-white text-white px-8 py-3 rounded-lg font-semibold hover:bg-white hover:text-purple-600">
                      View Lookbook
                    </button>
                  </div>
                </div>
                <div className="text-6xl text-center">
                  üõçÔ∏è
                </div>
              </div>
            </div>
          </section>

          {/* Trust Badges */}
          <section className="py-8 bg-white border-b">
            <div className="max-w-7xl mx-auto px-4">
              <div className="grid grid-cols-2 md:grid-cols-4 gap-6">
                <div className="flex items-center space-x-3">
                  <Truck className="w-8 h-8 text-purple-600" />
                  <div>
                    <div className="font-semibold text-sm">Free Shipping</div>
                    <div className="text-xs text-gray-600">On orders over $50</div>
                  </div>
                </div>
                <div className="flex items-center space-x-3">
                  <Shield className="w-8 h-8 text-purple-600" />
                  <div>
                    <div className="font-semibold text-sm">Secure Payment</div>
                    <div className="text-xs text-gray-600">100% protected</div>
                  </div>
                </div>
                <div className="flex items-center space-x-3">
                  <ArrowRight className="w-8 h-8 text-purple-600" />
                  <div>
                    <div className="font-semibold text-sm">Easy Returns</div>
                    <div className="text-xs text-gray-600">30-day policy</div>
                  </div>
                </div>
                <div className="flex items-center space-x-3">
                  <MessageCircle className="w-8 h-8 text-purple-600" />
                  <div>
                    <div className="font-semibold text-sm">24/7 Support</div>
                    <div className="text-xs text-gray-600">AI-powered chat</div>
                  </div>
                </div>
              </div>
            </div>
          </section>

          {/* Products Section */}
          <section className="py-12 max-w-7xl mx-auto px-4">
            <div className="flex items-center justify-between mb-8">
              <h2 className="text-3xl font-bold">Trending Now</h2>
              <button className="flex items-center space-x-2 text-purple-600 font-semibold hover:text-purple-700">
                <Filter className="w-5 h-5" />
                <span>Filter & Sort</span>
                <ChevronDown className="w-4 h-4" />
              </button>
            </div>

            <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
              {products.map((product) => (
                <div key={product.id} className="bg-white rounded-xl shadow-sm hover:shadow-xl transition-all group cursor-pointer overflow-hidden">
                  <div className="relative">
                    <div className={`${product.color} h-64 flex items-center justify-center text-7xl group-hover:scale-110 transition-transform`}>
                      {product.image}
                    </div>
                    {product.badge && (
                      <span className="absolute top-3 left-3 bg-red-600 text-white px-3 py-1 rounded-full text-xs font-bold">
                        {product.badge}
                      </span>
                    )}
                    <button className="absolute top-3 right-3 bg-white p-2 rounded-full shadow-md hover:bg-pink-50">
                      <Heart className="w-5 h-5 text-gray-600 hover:text-pink-600" />
                    </button>
                  </div>

                  <div className="p-5">
                    <h3 className="font-semibold text-lg mb-2 group-hover:text-purple-600">{product.name}</h3>
                    <div className="flex items-center mb-3">
                      <div className="flex items-center">
                        {[...Array(5)].map((_, i) => (
                          <Star key={i} className="w-4 h-4 text-yellow-400 fill-current" />
                        ))}
                      </div>
                      <span className="ml-2 text-sm text-gray-600">
                        {product.rating} ({product.reviews})
                      </span>
                    </div>

                    <div className="flex items-center justify-between">
                      <div>
                        <span className="text-2xl font-bold text-gray-900">${product.price}</span>
                        {product.oldPrice && (
                          <span className="ml-2 text-sm text-gray-500 line-through">${product.oldPrice}</span>
                        )}
                      </div>
                      <button className="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 font-medium text-sm">
                        Add to Cart
                      </button>
                    </div>
                  </div>
                </div>
              ))}
            </div>

            <div className="text-center mt-10">
              <button className="bg-gray-900 text-white px-8 py-3 rounded-lg font-semibold hover:bg-gray-800">
                Load More Products
              </button>
            </div>
          </section>

          {/* Newsletter */}
          <section className="bg-gradient-to-r from-purple-600 to-pink-600 text-white py-12">
            <div className="max-w-3xl mx-auto px-4 text-center">
              <h2 className="text-3xl font-bold mb-4">Get 10% Off Your First Order</h2>
              <p className="text-purple-100 mb-6">Subscribe to our newsletter for exclusive deals and new arrivals</p>
              <div className="flex max-w-md mx-auto">
                <input type="email" placeholder="Enter your email"
                  className="flex-1 px-4 py-3 rounded-l-lg text-gray-900 focus:outline-none" />
                <button className="bg-gray-900 text-white px-6 py-3 rounded-r-lg font-semibold hover:bg-gray-800">
                  Subscribe
                </button>
              </div>
            </div>
          </section>

          {/* Chat Widget */}
          <div className={`fixed bottom-24 right-6 w-96 bg-white rounded-lg shadow-2xl border border-gray-200 overflow-hidden z-50 transition-all duration-300 transform origin-bottom-right ${chatOpen ? 'scale-100 opacity-100 translate-y-0' : 'scale-95 opacity-0 translate-y-4 pointer-events-none'}`}>
            {/* Chat Header */}
            <div className="bg-gradient-to-r from-purple-600 to-pink-600 text-white p-4 flex items-center justify-between">
              <div className="flex items-center space-x-3">
                <MessageCircle className="w-6 h-6" />
                <div>
                  <h3 className="font-semibold">AI Shopping Assistant</h3>
                  <p className="text-xs text-purple-100">Always here to help</p>
                </div>
              </div>
            </div>

            {/* Category Selector */}
            <div className="p-4 bg-gray-50 border-b">
              <p className="text-sm text-gray-600 mb-2">How can we help you today?</p>
              <div className="grid grid-cols-2 gap-2">
                {categories.map((cat) => (
                  <button
                    key={cat.id}
                    onClick={() => handleQuickReply(cat.id.toString())}
                    className="flex items-center space-x-2 px-3 py-2 bg-white border border-gray-200 rounded-lg hover:border-purple-600 hover:bg-purple-50 text-sm transition-all"
                  >
                    <span>{cat.icon}</span>
                    <span className="text-left text-xs">{cat.name}</span>
                  </button>
                ))}
              </div>
            </div>

            {/* Messages */}
            <div className="h-96 overflow-y-scroll p-4 space-y-4">
              {messages.map((msg, idx) => (
                <div key={idx} className={`flex ${msg.type === 'user' ? 'justify-end' : 'justify-start'}`}>
                  <div className={`max-w-[80%] rounded-lg p-3 ${msg.type === 'user'
                    ? 'bg-purple-600 text-white'
                    : msg.type === 'system'
                      ? 'bg-yellow-50 text-yellow-900 border border-yellow-200'
                      : msg.type === 'error'
                        ? 'bg-red-50 text-red-900 border border-red-200'
                        : 'bg-gray-100 text-gray-900'
                    }`}>
                    <p className="text-sm">{msg.text}</p>
                  </div>
                </div>
              ))}
              {isTyping && (
                <div className="flex justify-start">
                  <div className="bg-gray-100 rounded-lg p-3">
                    <div className="flex space-x-1">
                      <div className="w-2 h-2 bg-gray-400 rounded-full animate-bounce"></div>
                      <div className="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style={{ animationDelay: '0.2s' }}></div>
                      <div className="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style={{ animationDelay: '0.4s' }}></div>
                    </div>
                  </div>
                </div>
              )}
              <div ref={messagesEndRef} />
            </div>

            {/* Quick Replies */}
            <div className="px-4 py-2 bg-gray-50 border-t flex flex-wrap gap-2">
              {quickReplies.map((reply) => (
                <button
                  key={reply}
                  onClick={() => handleQuickReply(reply)}
                  className="px-3 py-1 bg-white border border-gray-300 rounded-full text-xs hover:border-purple-600 hover:bg-purple-50"
                >
                  {reply}
                </button>
              ))}
            </div>

            {/* Input */}
            <div className="p-4 border-t">
              <div className="flex space-x-2">
                <input
                  type="text"
                  value={input}
                  onChange={(e) => setInput(e.target.value)}
                  onKeyPress={(e) => e.key === 'Enter' && handleSend()}
                  placeholder="Type your message..."
                  className="flex-1 border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-purple-600 text-sm"
                />
                <button
                  onClick={handleSend}
                  className="bg-purple-600 text-white p-2 rounded-lg hover:bg-purple-700"
                >
                  <Send className="w-5 h-5" />
                </button>
              </div>
            </div>
          </div>

          {/* Chat Button */}
          <button
            onClick={() => setChatOpen(!chatOpen)}
            className={`fixed bottom-6 right-6 p-4 rounded-full shadow-lg hover:shadow-xl transition-all duration-300 z-50 ${chatOpen ? 'bg-gray-900 rotate-90' : 'bg-gradient-to-r from-purple-600 to-pink-600 rotate-0'}`}
          >
            {chatOpen ? (
              <X className="w-6 h-6 text-white" />
            ) : (
              <MessageCircle className="w-6 h-6 text-white" />
            )}
          </button>
        </div>
      );
    }

    createRoot(document.getElementById('root')).render(<ShopifyDemo />);
  </script>
</body>

</html>