services:
  # Python Backend
  - type: web
    name: ai-support-api
    env: python
    region: oregon
    plan: free
    rootDir: server
    buildCommand: pip install poetry && poetry install
    startCommand: poetry run uvicorn main:app --host 0.0.0.0 --port $PORT
    envVars:
      - key: API_SECRET_KEY
        generateValue: true
      - key: API_HOST
        value: 0.0.0.0
      - key: SUPABASE_URL
        sync: false
      - key: SUPABASE_KEY
        sync: false
      - key: N8N_WEBHOOK_BASE_URL
        sync: false
      - key: N8N_AGENT_MESSAGE_WEBHOOK
        value: agent-console-bridge
      - key: N8N_TAKEOVER_WEBHOOK
        value: human-takeover-trigger
      - key: OPENAI_API_KEY
        sync: false
      - key: ALLOWED_ORIGINS
        value: "*"
    healthCheckPath: /health

  # n8n Automation
  - type: web
    name: ai-support-n8n
    env: docker
    plan: free
    rootDir: ai-support-n8n
    healthCheckPath: /healthz
    envVars:
      - key: N8N_BASIC_AUTH_ACTIVE
        value: true
      - key: N8N_BASIC_AUTH_USER
        value: admin
      - key: N8N_BASIC_AUTH_PASSWORD
        generateValue: true
      - key: N8N_ENCRYPTION_KEY
        generateValue: true
      - key: POSTGRES_HOST
        sync: false
      - key: POSTGRES_DB
        value: postgres
      - key: POSTGRES_USER
        value: postgres
      - key: POSTGRES_PASSWORD
        sync: false
      - key: PINECONE_INDEX_URL
        sync: false
      - key: PINECONE_API_KEY
        sync: false
      - key: FASTAPI_BASE_URL
        fromService:
          type: web
          name: ai-support-api
          property: url
      - key: N8N_WEBHOOK_BASE
        fromService:
          type: web
          name: ai-support-n8n
          property: url

